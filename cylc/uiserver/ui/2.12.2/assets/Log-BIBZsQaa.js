import{_ as U,br as Q,P as S,bs as G,bt as j,bu as H,an as Y,v as T,y as g,e as u,x as C,F as K,r as Z,az as X,A as L,bv as $,aq as ee,ap as J,o as n,t as m,L as te,bw as oe,bx as le,by as se,bz as ie,bA as ae,bB as re,a6 as ne,w as l,bC as de,bD as ue,ad as ce,bE as fe,bF as pe,bG as he,ae as D,bH as me,bI as ge,bJ as be,p as W,bK as we,aj as h,H as N,I as ve,bL as ye,B as x,g as s,V as F,h as V,U as ke,k as y,bM as O,b8 as _,C as P,bN as Le,b4 as Ie,af as q,z as De,D as xe,bO as Ve}from"./index-Dq7pRljC.js";import{V as Se,b as Te}from"./ViewToolbar-BxY_zjR_.js";import{g as Fe}from"./graphql-AydNY7Tm.js";import{i as _e,u as je,a as k}from"./initialOptions-C09CLyM5.js";import{V as R}from"./VContainer-Cab4EUF0.js";import{d as Ce}from"./debounce-CWhmRsh7.js";import{V as Ne}from"./VAlert-CmUYqfJh.js";const Be={name:"LogComponent",props:{placeholder:{type:String,required:!1},timestamps:{type:Boolean,required:!1,default:!0},logs:{type:Array,required:!0},wordWrap:{type:Boolean,required:!1,default:!1},autoScroll:{type:Boolean,required:!1,default:!1}},emits:["update:autoScroll"],setup(o,{emit:e}){const i=S("logText"),t=S("scrollWrapper"),b=S("autoScrollEnd"),r=$(o,"autoScroll",e),{arrivedState:c,directions:f}=G(t);j(()=>c.bottom&&!c.top,()=>{r.value=!0}),j(()=>o.logs.length&&f.top,()=>{r.value=!1});function p(){b.value?.scrollIntoView({behavior:"smooth"})}async function w(){r.value=!1,await ee(),t.value?.scroll({top:0,left:0,behavior:"smooth"})}const a=new ResizeObserver(p);return H(i,()=>{J(r,I=>{I?(p(),a.observe(i.value)):(t.value.scrollBy(0,0),a.disconnect())},{immediate:!0})}),Y(()=>{a.disconnect()}),{scrollToTop:w}},computed:{computedLogs(){return this.logs.length>0?this.timestamps?this.logs:this.updateLogs():this.placeholder?[this.placeholder]:[]}},methods:{updateLogs(){return this.logs.map(o=>this.stripTimestamp(o))},stripTimestamp(o){const e=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-][\d:]+)?\s(.*\s*)/;return o.match(e)?.[1]??o}},icons:{mdiMouseMoveUp:Q}},We={ref:"scrollWrapper",class:"h-100 overflow-auto px-4 pb-2"},Oe={ref:"autoScrollEnd"};function Pe(o,e,i,t,b,r){return n(),T("div",We,[g("pre",{ref:"logText",class:X(i.wordWrap?"text-pre-wrap text-break":"text-pre"),"data-cy":"log-text"},[(n(!0),T(K,null,Z(r.computedLogs,(c,f)=>(n(),T("span",{key:f},m(c),1))),128))],2),i.logs.length?(n(),u(L,{key:0,position:"fixed",location:"bottom right",class:"ma-5",onClick:t.scrollToTop,icon:o.$options.icons.mdiMouseMoveUp,"data-cy":"log-scroll-top"},null,8,["onClick","icon"])):C("",!0),g("div",Oe,null,512)],512)}const qe=U(Be,[["render",Pe]]),Re=N`
subscription LogData ($id: ID!, $file: String!) {
  logs (id: $id, file: $file) {
    lines
    connected
    path
    error
  }
}
`,Ee=N`
query LogFiles($id: ID!) {
  logFiles(id: $id) {
    files
  }
}
`,Ue=N`
query Jobs($id: ID!, $workflowId: ID!) {
  jobs (live: false, ids: [$id], workflows: [$workflowId]) {
    id
    state
    platform
    jobId
    jobRunnerName
    submittedTime
    startedTime
    finishedTime
  }
}
`;class E{constructor(){this.lines=[],this.host=null,this.path=null,this.connected=null,this.error=null}}class Je extends ve{constructor(e){super(),this.results=e}onAdded(e,i,t){this.results.connected===!1&&(this.results.lines=[]),e.lines&&this.results.lines.push(...e.lines),e.connected!=null&&(this.results.connected=e.connected),e.error!=null&&(this.results.error=e.error),e.path!=null&&([this.results.host,this.results.path]=e.path.split(":",2))}}const Me={name:"Log",mixins:[Fe,ne],components:{CopyBtn:re,LogComponent:qe,ViewToolbar:Se,JobDetails:ae},emits:[je],props:{initialOptions:_e,widgetID:{type:String,required:!1,default:null}},setup(o,{emit:e}){const i=ye(),t=k("relativeID",{props:o,emit:e}),b=ge(t),r=be(t.value,{onChanged:Ce(d=>{t.value=d},500)});function c(d){return!d||(D.validate(d,!0)??!0)}const f=W(()=>{if(t.value)try{const d=new D(t.value,!0);if(d.task)return d.job?d:d.clone({job:"NN"})}catch{}return null}),p=k("file",{props:o,emit:e}),w=k("timestamps",{props:o,emit:e},!0),a=we(),I=k("wordWrap",{props:o,emit:e},a.value);J(I,d=>{a.value=d});const v=h(new E);function M(){v.value=new E}const z=W(()=>v.value.path?.substring(0,v.value.path.length-p.value.length-1));j(()=>i.state.offline,()=>{v.value.connected=!1});const A=k("autoScroll",{props:o,emit:e},!0),B="40";return{query:h(null),logFiles:h([]),results:v,parentPath:z,relativeID:t,previousRelativeID:b,inputID:r,validateInputID:c,relativeTokens:f,Tokens:D,file:p,fileLabel:h("Select File"),fileDisabled:h(!1),jobLog:h(t.value==null?0:1),timestamps:w,wordWrap:I,autoScroll:A,reset:M,toolbarBtnSize:B,toolbarBtnProps:Te(B),jobNode:h(null)}},mounted(){this.$watch(()=>({id:this.id??void 0,file:this.file??void 0}),async({id:o,file:e},i)=>{if(this.widgetID){const t=this.relativeID?`${this.relativeID} â€“ `:"";me.emit(`lumino:update-tab:${this.widgetID}`,{title:`Log: ${this.jobLog?"Job":"Workflow"}`,caption:`${t}${e??"No file selected"}`})}this.updateQuery(),o!==i?.id&&await this.setNewFile(!i)},{immediate:!0})},computed:{workflowTokens(){return new D(this.workflowId)},id(){return this.jobLog?this.relativeTokens?.clone(this.workflowTokens)?.id:this.workflowId},controlGroups(){return[{title:"Log",controls:[{title:"Timestamps",icon:fe,action:"toggle",value:this.timestamps,key:"timestamps"},{title:"Word wrap",icon:pe,action:"toggle",value:this.wordWrap,key:"wordWrap"},{title:"Auto scroll",icon:he,action:"toggle",value:this.autoScroll,key:"autoScroll"}]}]}},methods:{setOption(o,e){this[o]=e},updateQuery(){if(this.reset(),!this.file||!this.id){this.query=null;return}this.query=new ce(Re,{id:this.id,file:this.file},`log-query-${this._uid}`,[new Je(this.results)],!1,!1)},async fetchJobData(){let o;this.jobNode=null;try{this.relativeTokens&&(o=await this.$workflowService.query2(Ue,{id:this.relativeTokens.id,workflowId:this.workflowTokens.workflow}))}catch(e){return console.error(e),!1}return this.jobNode=o?.data?.jobs?.[0]??!1,this.jobNode},getDefaultWorkflowLog(){return this.logFiles.find(o=>o.startsWith("scheduler/"))},async updateLogFileList(){if(!this.id){this.handleNoLogFiles();return}this.fileLabel="Updating available files...",this.fileDisabled=!0;let o;try{o=await this.$workflowService.apolloClient.query({query:Ee,variables:{id:this.id}})}catch(i){this.handleLogFileListingErr(i),this.handleNoLogFiles();return}if(!this.id)return;const e=o.data.logFiles?.files??[];e.length?(this.fileLabel="Select File",this.fileDisabled=!1,this.logFiles=e):(o.errors?.length&&this.handleLogFileListingErr(o.errors[0].message),this.handleNoLogFiles())},async setNewFile(o){const e=[this.updateLogFileList()];this.jobLog&&!o&&e.push(this.fetchJobData().then(i=>{this.file=ue(i?.state)})),await Promise.all(e),this.jobLog||(this.file=this.getDefaultWorkflowLog())},handleNoLogFiles(){this.fileLabel=this.id?`No log files for ${this.id}`:"Enter a task/job ID",this.fileDisabled=!0,this.logFiles=[]},handleLogFileListingErr(o){this.$store.dispatch("setAlert",new de(o,"error"))}},watch:{jobLog(o,e){this.file=null,this.relativeID=o?this.previousRelativeID:null}},icons:{mdiFolderRefresh:ie,mdiPowerPlug:se,mdiPowerPlugOff:le,mdiFileAlertOutline:oe,mdiInformationOutline:te}},ze={"data-cy":"log-path",class:"ml-2 mr-1 d-flex text-medium-emphasis text-pre overflow-x-hidden"},Ae={class:"flex-shrink-1 text-truncate"},Qe={class:"text-pre-wrap text-break"};function Ge(o,e,i,t,b,r){const c=x("ViewToolbar"),f=x("JobDetails"),p=x("CopyBtn"),w=x("log-component");return n(),u(R,{class:"c-log h-100 pa-0 d-flex flex-column",fluid:""},{default:l(()=>[s(R,{fluid:""},{default:l(()=>[s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[s(V,{class:"pt-0"},{default:l(()=>[s(ke,{modelValue:t.jobLog,"onUpdate:modelValue":e[0]||(e[0]=a=>t.jobLog=a),divided:"",mandatory:"",variant:"outlined",color:"primary",density:"comfortable"},{default:l(()=>[s(L,{"data-cy":"workflow-toggle"},{default:l(()=>[...e[7]||(e[7]=[y("Workflow",-1)])]),_:1}),s(L,{"data-cy":"job-toggle"},{default:l(()=>[...e[8]||(e[8]=[y("Job",-1)])]),_:1})]),_:1},8,["modelValue"]),s(c,{groups:r.controlGroups,onSetOption:r.setOption,size:t.toolbarBtnSize},null,8,["groups","onSetOption","size"])]),_:1})]),_:1}),s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[s(V,{cols:"8"},{default:l(()=>[t.jobLog?(n(),u(O,{key:0,"data-cy":"job-id-input",class:"flex-grow-1 flex-column",modelValue:t.inputID,"onUpdate:modelValue":e[2]||(e[2]=a=>t.inputID=a),rules:[t.validateInputID],placeholder:"cycle/task/job",clearable:""},{"prepend-inner":l(()=>[s(L,_({disabled:!t.relativeTokens||t.jobNode===!1},t.toolbarBtnProps,{size:"medium",variant:"plain",onClick:e[1]||(e[1]=()=>t.jobNode??r.fetchJobData()),"data-cy":"job-info-btn"}),{default:l(()=>[s(P,{icon:o.$options.icons.mdiInformationOutline},null,8,["icon"]),s(Le,{activator:"parent","close-on-content-click":!1},{default:l(()=>[s(Ie,{class:"pa-2"},{default:l(()=>[t.jobNode?(n(),u(f,{key:1,node:t.jobNode,density:"compact",hover:""},{header:l(()=>[y(m(new t.Tokens(t.jobNode.id).relativeID),1)]),_:1},8,["node"])):(n(),u(q,{key:0,type:"text@6"}))]),_:1})]),_:1})]),_:1},16,["disabled"])]),_:1},8,["modelValue","rules"])):(n(),u(O,{key:1,"data-cy":"workflow-id-input",modelValue:o.workflowId,"onUpdate:modelValue":e[3]||(e[3]=a=>o.workflowId=a),disabled:""},null,8,["modelValue"]))]),_:1}),s(V,{cols:"4",class:"d-flex align-start col-gap-2"},{default:l(()=>[s(De,{"data-cy":"file-input",label:t.fileLabel,disabled:t.fileDisabled,items:t.logFiles,modelValue:t.file,"onUpdate:modelValue":e[4]||(e[4]=a=>t.file=a),"menu-props":{"data-cy":"file-input-menu"}},null,8,["label","disabled","items","modelValue"]),s(L,_({onClick:e[5]||(e[5]=()=>this.updateLogFileList())},t.toolbarBtnProps,{"data-cy":"refresh-files"}),{default:l(()=>[s(P,{icon:o.$options.icons.mdiFolderRefresh},null,8,["icon"]),s(xe,null,{default:l(()=>[...e[9]||(e[9]=[y("Refresh file list",-1)])]),_:1})]),_:1},16)]),_:1})]),_:1}),s(F,{dense:"",class:"flex-0-0"},{default:l(()=>[t.results.path?(n(),u(V,{key:0,class:"d-flex align-center"},{default:l(()=>[s(Ve,_({"data-cy":"connected-icon",variant:"outlined",class:"flex-shrink-0"},t.results.connected?{color:"success",prependIcon:o.$options.icons.mdiPowerPlug}:{color:"error",prependIcon:o.$options.icons.mdiPowerPlugOff,onClick:r.updateQuery}),{default:l(()=>[y(m(t.results.connected?"Connected":"Reconnect"),1)]),_:1},16),g("div",ze,[g("span",null,m(t.results.host)+":",1),g("span",Ae,m(t.parentPath),1),g("span",null,"/"+m(t.file),1)]),s(p,{text:t.results.path,tooltip:"Copy path"},null,8,["text"])]),_:1})):C("",!0)]),_:1}),t.results.error?(n(),u(Ne,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2",icon:o.$options.icons.mdiFileAlertOutline},{default:l(()=>[g("span",Qe,m(t.results.error),1)]),_:1},8,["icon"])):C("",!0)]),_:1}),r.id&&t.file&&t.results.connected==null?(n(),u(q,{key:0,type:"text@5",class:"align-content-start"})):(n(),u(w,{key:1,"data-cy":"log-viewer",logs:t.results.lines,timestamps:t.timestamps,"word-wrap":t.wordWrap,autoScroll:t.autoScroll,"onUpdate:autoScroll":e[6]||(e[6]=a=>t.autoScroll=a)},null,8,["logs","timestamps","word-wrap","autoScroll"]))]),_:1})}const tt=U(Me,[["render",Ge]]);export{tt as default};
